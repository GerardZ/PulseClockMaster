<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PulseClockMaster</title>

    <script src="myWebsockets.js"></script>
    <script src="7segment.js"></script>

    <style>
        body {
            background-color: #555;
            /* Page background */
            font-family: sans-serif;
            margin: 0;
            padding: 0;
        }

        .page {
            width: 800px;
            margin: 2px auto;
            background-color: #555;
            /* Same grey as border for blend */
            /*border: 1px solid #ccc;*/
            /* Subtle border */
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.05);
        }

        /* Top navigation bar */
        .topnav {
            background-color: #444;
            color: white;
            display: flex;
            position: relative;
            justify-content: space-around;
            padding: 5px;
        }

        .topnav a {
            color: grey;
            text-decoration: none;
            position: absolute;
            top: 52px;
            right: 12px;
        }

        .topnav a:hover {
            color: white;
            
        }

        /* Secondary menu bar */
        .menubar {
            background-color: #e0e0e0;
            display: flex;
            justify-content: right;
            border-bottom: 1px solid #ccc;
            padding: 3px;
        }

        .content {
            position: relative;
            padding: 20px;
        }

        .horAlign {

            display: flex;
            flex-direction: row;
            /* Stack vertically */
            height: 50px;
            /* Full viewport height (or any fixed height) */
        }

        .horAlign div {
            flex: 1;
            /* Take equal share of parent height */
            padding: 2px;
            box-sizing: border-box;
        }

        .dot {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 12px;
            height: 12px;
            background-color: #E44;
            opacity: 30%;
            border-radius: 50%;
            pointer-events: none;
            /* Optional: makes it non-interactive */
        }

        #disconnect-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(50, 50, 50, 0.7);
            color: white;
            font-size: 2rem;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
    </style>
</head>

<body>
    <div class="page">
        <div class="topnav">
            <h2>PulseClockMaster</h2>
            <a href="https://github.com/GerardZ/PulseClockMaster/blob/main/Readme.md" target="_blank">about</a>
        </div>

        <div id="disconnect-overlay">
            Disconnected from server
        </div>

        <div class="content">

            <div style="height:120px; width: 100%;">
                <div id="display1" style="margin:auto;width: 70%;"></div>
                <div id="pulseDot1" class="dot"></div>
            </div>

            <div style="height:12px; width: 100%;"></div>

            <div class="horAlign">
                <div></div>
                <div></div>
                <div id="displayDay"></div>
                <div id="displayYMonth"></div>
                <div id="displayYear"></div>
                <div></div>
                <div></div>
            </div>
        </div>

    </div>


    <script>
        const bgColor = "#555";
        const fgColor = "#E44";
        const display1 = new SegmentDisplay("display1", "00:00:00", 10, bgColor, fgColor);
        display1.setClockDots(true);
        const displayYear = new SegmentDisplay("displayYear", "0000", 10, bgColor, fgColor);
        const displayYMonth = new SegmentDisplay("displayYMonth", "00", 10, bgColor, fgColor);
        const displayDay = new SegmentDisplay("displayDay", "00", 10, bgColor, fgColor);

        const wsHandler = new WebSocketHandler(
            {
                onConnectionStateChange: (state) => {

                    handleConnectState(state);
                },
                onMessageReceived: (msg) => {
                    handleWsMessage(msg);
                }
                //REMOVE This will be removed by CompressHTML.py and is for debugging through live server in VsCode
                , debugUrl: "ws://192.168.0.164/ws"
                //ENDREMOVE
            });

        function handleConnectState(state) {
            console.log("Connection state:", state);
            const overlay = document.getElementById("disconnect-overlay");
            if (state == "connected") overlay.style.display = "none";
            else overlay.style.display = "flex";
        }

        function handleWsMessage(msg) {
            console.log(msg);
            const jsonObj = JSON.parse(msg);

            display1.displayNumber(jsonObj.time || "00:00:00");
            displayYear.displayNumber(jsonObj.year + 2000 || "0000");
            displayYMonth.displayNumber(jsonObj.month || "00");
            displayDay.displayNumber(jsonObj.mday || "00");

            setPulseDot(jsonObj.pulse);
        }

        function setPulseDot(value) {
            dot = document.getElementById("pulseDot1");
            dot.style.opacity = value ? "1" : "0.3";
        }
    </script>
</body>

</html>